{"name":"df_transform_ventes","properties":{"type":"MappingDataFlow","typeProperties":{"sources":[{"dataset":{"referenceName":"ventes_csv","type":"DatasetReference"},"name":"ventesSource"},{"dataset":{"referenceName":"clients_sql","type":"DatasetReference"},"name":"clientsSource"},{"dataset":{"referenceName":"catalog_json","type":"DatasetReference"},"name":"catalogSource"},{"dataset":{"referenceName":"regions_sql","type":"DatasetReference"},"name":"regionsSource"}],"sinks":[{"dataset":{"referenceName":"sink_silver_parquet","type":"DatasetReference"},"name":"sinkSilver"},{"dataset":{"referenceName":"sink_sql_reportingventes","type":"DatasetReference"},"name":"sinkSQL"}],"transformations":[{"name":"flattenCatalog"},{"name":"joinVentesClients"},{"name":"joinVentesCatalog"},{"name":"joinClientsRegions"},{"name":"selectColumns"},{"name":"filterQuantite"},{"name":"derivedColumns"}],"scriptLines":["source(output(","          id as string,","          date as string,","          produit_id as string,","          montant as string,","          client_id as string,","          quantite as string","     ),","     allowSchemaDrift: false,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> ventesSource","source(output(","          client_id as string,","          nom as string,","          prenom as string,","          age as integer,","          pays as string,","          date_inscription as string","     ),","     allowSchemaDrift: false,","     validateSchema: false,","     isolationLevel: 'READ_UNCOMMITTED',","     format: 'table') ~> clientsSource","source(output(","          catalogue as (produit_id as string, nom as string, categorie as string, prix_catalogue as double)[]","     ),","     allowSchemaDrift: false,","     validateSchema: false,","     ignoreNoFilesFound: false,","     documentForm: 'singleDocument') ~> catalogSource","source(output(","          pays as string,","          zone as string","     ),","     allowSchemaDrift: false,","     validateSchema: false,","     isolationLevel: 'READ_UNCOMMITTED',","     format: 'table') ~> regionsSource","catalogSource foldDown(unroll(catalogue),","     mapColumn(","          produit_id = catalogue.produit_id,","          nom = catalogue.nom,","          categorie = catalogue.categorie,","          prix_catalogue = catalogue.prix_catalogue","     ),","     skipDuplicateMapInputs: false,","     skipDuplicateMapOutputs: false) ~> flattenCatalog","ventesSource, clientsSource join(ventesSource@client_id == clientsSource@client_id,","     joinType:'inner',","     matchType:'exact',","     ignoreSpaces: false,","     broadcast: 'auto')~> joinVentesClients","joinVentesClients, flattenCatalog join(ventesSource@produit_id == flattenCatalog@produit_id,","     joinType:'left',","     matchType:'exact',","     ignoreSpaces: false,","     broadcast: 'auto')~> joinVentesCatalog","joinVentesCatalog, regionsSource join(clientsSource@pays == regionsSource@pays,","     joinType:'left',","     matchType:'exact',","     ignoreSpaces: false,","     broadcast: 'auto')~> joinClientsRegions","joinClientsRegions select(mapColumn(","          id,","          date,","          produit_id = ventesSource@produit_id,","          client_id = ventesSource@client_id,","          montant,","          quantite,","          categorie,","          pays = clientsSource@pays,","          zone,","          age,","          prix_catalogue","     ),","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> selectColumns","selectColumns filter(toInteger(quantite) > 0) ~> filterQuantite","filterQuantite derive(date = toDate(date, 'yyyy-MM-dd'),","          montant = toDecimal(montant, 10, 2),","          quantite = toInteger(quantite),","          ca_total = toDecimal(montant, 10, 2) * toInteger(quantite),","          is_senior = iif(age >= 60, true(), false()),","          annee = year(toDate(date, 'yyyy-MM-dd')),","          mois = month(toDate(date, 'yyyy-MM-dd')),","          produit_in_catalogue = iif(isNull(produit_id), 'NON', 'OUI')) ~> derivedColumns","derivedColumns sink(allowSchemaDrift: true,","     validateSchema: false,","     format: 'parquet',","     umask: 0022,","     preCommands: [],","     postCommands: [],","     compressionCodec: 'snappy') ~> sinkSilver","derivedColumns sink(allowSchemaDrift: true,","     validateSchema: false,","     deletable:false,","     insertable:true,","     updateable:false,","     upsertable:false,","     format: 'table',","     preSQLs:['TRUNCATE TABLE dbo.ReportingVentes'],","     errorHandlingOption: 'stopOnFirstError') ~> sinkSQL"]}}}